# 课题组网站与新闻发布系统 — 技术方案详细说明

更新时间：2025-10-25

## 概述

本项目为“地球观测与模拟课题组”官方站点与新闻发布系统，包含首页、研究团队、承担课题、研究成果、科研资源、新闻模块（列表与详情）、英文版主页以及一个简易的管理后台与访问统计。前端以 Layui 为 UI 基座，配合原生 JavaScript 实现模块化逻辑与性能优化；后端基于 Node.js + Express，使用 SQLite 持久化新闻与访问统计数据，提供新闻增删改查与图片上传等 REST API，并带有安全与限流中间件。

核心特点：
- 前端支持“静态数据”与“后端 API”双数据源，自动降级回退，便于离线部署与逐步演进；
- 管理后台集成富文本（Quill），支持图文混排、图片上传与占位符解析，保障排版体验；
- 后端采用 Helmet + 限流 + CORS + Session 基础安全组合，图片上传限制与压缩（完整版）兼具性能与安全；
- 采用 IntersectionObserver、requestAnimationFrame、AOS 等手段，优化滚动与动画性能，移动端体验友好。


## 架构总览

- 前端：
  - UI 框架：Layui（`layui.css`、`layui.js`），AOS 滚动动效，Font Awesome 图标；
  - 主要页面：`Main.html`（首页）、`Group/Group.html`、`Projects/Projects.html`、`Results/Results.html`、`Resources/Resources.html`、`News/News_Page.html`、`News/News.html`、`Main_en.html`；
  - 主要脚本：
    - 首页逻辑：`Main.js`（导航滚动、新闻简报、研究领域轮播）
    - 导航适配与路径：`Head&Foot.js`（PC/移动导航、基于 URL 深度的相对路径生成、可选 Vue 绑定兼容）
    - 研究领域数据：`research_areas_data.js`（轮播数据与响应式配置）
    - 新闻前端 API（主页/列表/详情）：`js/news-api.js`、`News/News_List_API.js`、`News/News_api.js`（含回退策略）
    - 访问统计：`js/visitor-tracker.js`（可按端口开关）

- 后端：Node.js + Express（`backend/server.js`）
  - 安全：Helmet CSP、限流、Session（Cookie-based）
  - 路由：
    - 新闻：`backend/routes/news.js`（完整版，含图片压缩与多种上传/关联方式）或 `news-simple.js`（无压缩的简化版）
    - 统计：`backend/routes/statistics.js`
  - 数据访问：SQLite 封装（`backend/config/database.js` 或 `database-simple.js`）
  - 模型：`backend/models/News.js`、`backend/models/Statistics.js`
  - 静态资源：`/uploads`（新闻图片）、`/admin`（管理后台静态页）、站点根（前端页面直出）

- 数据库：SQLite（`backend/database/website.db`，建表脚本 `backend/database/schema.sql`）

- 管理后台：`backend/public/admin/`（登录页与控制台页），支持登录、新闻管理、访问指标查看（调用后端 API）

- 其他：`XBEARVIEW/` 为切片与资源展示页面（单页打包构建产物），与主站同部署。


## 功能模块说明

### 1) 首页（`Main.html` + `Main.js`）
- 顶部导航：Layui 导航 + PC/移动适配（移动端侧边垂直菜单，按钮展开收起，图标动态切换）。
- 首屏/关于我们/科研生活：AOS 动画、模态图查看（点击缩略图放大）。
- 组内新闻：
  - 优先从后端 `GET /api/news/latest?limit=5` 拉取最新新闻；
  - 若后端不可用，回退至 `News/News_data/News_X/news_X.js` 静态数据；
  - 自动生成“MORE”链接跳转 `News/News_Page.html`。
- 研究领域轮播：使用 `research_areas_data.js` 数据 + 自研轮播类 `ResearchCarousel`，支持键盘导航、触摸滑动、响应式展示（1/2/3 列）。

### 2) 新闻系统（前端页面 + 后端 API）
- 新闻列表页：`News/News_Page.html` 调用 `News/News_List_API.js`，支持：
  - 数据库优先，失败回退到 `getNewsList` 预定义 JS 列表；
  - 分页参数与重试逻辑、10s 超时与错误提示。
- 新闻详情页：`News/News.html` 调用 `News/News_api.js`，支持：
  - 数据库详情 -> 统一转换为前端可渲染结构（段落+图片、内容块或富文本 HTML）；
  - 支持内容中的图片占位符（`[IMAGE:xxx.jpg]`）替换为实际图片；
  - 图片加载重试、占位与图注显示、交叉排布或内容块顺序渲染。

### 3) 研究团队/课题/成果/资源
- 纯前端静态页面，统一的页头/页脚与导航路径解析（`Head&Foot.js`），支撑多级子目录下的相对路径正确性。

### 4) 国际化
- `Main_en.html` 提供英文版首页；其余页面可按相同模式扩展。

### 5) 管理后台（`/admin`）
- 登录：`/admin/login`（示例凭证见“安全”章节说明）。
- 仪表盘：总访问、今日访问、独立访客、新闻数量、最近访问（均从 API 拉取，带默认演示数据占位）。
- 访问统计：页面排行、浏览器占比（可视表格）。
- 新闻管理：新增/编辑（Quill 富文本，首行缩进、行距自定义、图片插入）、删除、图片上传与排序/说明更新。

### 6) 访问统计
- 前端埋点：`js/visitor-tracker.js` 在指定端口启用时向 `POST /api/statistics/visit` 上报访问信息（UA、分辨率、语言、时区、URL 等）。
- 后端统计 API：概览、趋势、页面排行、地理分布、浏览器统计、小时分布、最近访问、按 IP 查询、清理历史数据。

### 7) XBEARVIEW
- 已构建单页资源（`XBEARVIEW/index.html` + assets + tiles），用于瓦片/视图展示，独立入口，随主站一并静态托管。


## 前端实现要点

- 技术与库：Layui（UI/组件/栅格/导航）、AOS（滚动动效）、Font Awesome（图标）、Google Fonts（中英文字体）。
- 导航与适配：
  - PC/Pad/Phone 三套导航（顶部横向 + 移动侧边栏），交互由 `Main.js` 与 `Head&Foot.js` 共同驱动；
  - `Head&Foot.js` 提供 `getBasePath()` 与 `generateLinks()`，基于当前 URL 深度生成正确相对路径，避免多级目录跳转问题；
  - 可选的 Vue 初始化（检测到 `:href`/`v-bind:href` 时绑定数据），兼容部分历史模板用法。
- 性能优化：
  - IntersectionObserver 控 AOS 动画触发；
  - requestAnimationFrame 包装滚动回调 + passive 事件；
  - 首页新闻与列表 API 具备超时/重试/缓存（`js/news-api.js`）；
  - 移动端关闭部分 AOS 以降功耗。
- 研究领域轮播：
  - 数据由 `research_areas_data.js` 提供；
  - `ResearchCarousel` 支持键盘、触摸、指示器与移动端独立按钮，栅格宽度随视口自适应。
- 图文细节：
  - 新闻图片地址自动在“数据库模式/静态模式”间切换，失败重试与占位图兜底；
  - 富文本详情支持 HTML 直出或“内容块”顺序渲染（文字/图片/混排）。


## 后端实现要点

- 启动与静态托管：
  - `backend/server.js` 默认端口：`process.env.PORT || 5500`；
  - 静态路径：`/uploads`（新闻图片）、`/admin`（管理后台），以及项目根目录（前端页面）；
  - 提供 `/`, `/Main.html`、`/*.html` 的直出回退处理。
- 安全：
  - Helmet（含 CSP 定制：允许 Google Fonts、CDNJS、Quill 等来源；img 支持 data:/https:/blob:）
  - express-rate-limit（15 分钟 100 次/IP，速率限制仅作用于 `/api/*`）
  - CORS：限定本地开发常用来源；
  - Session：`express-session` 管理后台登录态（Cookie-based）。
- API — 新闻（完整版 `routes/news.js`）：
  - `GET /api/news`：分页获取新闻列表（status、page、limit）；
  - `GET /api/news/latest`：最新新闻若干条；
  - `GET /api/news/search`：关键词搜索（title/content）；
  - `GET /api/news/:id`：新闻详情（含 images）；自动累积 `views`（非 admin 查询）；
  - `POST /api/news`：创建新闻（必需：title/content/publish_date，author 默认“管理员”）；
  - `PUT /api/news/:id`：更新新闻（包含 status/featured）；
  - `DELETE /api/news/:id`：删除新闻（含关联图片记录与文件）；
  - 图片上传：
    - `POST /api/news/temp-upload`：多图临时上传，返回文件名/描述/顺序（Jimp 压缩 1200x800, 85% 质量）；
    - `POST /api/news/:id/images`：两种用法
      - Content-Type: application/json 关联已上传图片（指定 `image_url` 与图注/顺序）
      - multipart/form-data 直传新图并关联
    - `PUT /api/news/images/:imageId`：更新图注/顺序
    - `DELETE /api/news/images/:imageId`：删除图片及物理文件
  - 简化版 `routes/news-simple.js`：移除压缩环节，接口兼容，适配无法编译原生依赖的环境。
- API — 统计（`routes/statistics.js`）：
  - `POST /api/statistics/visit`：记录访问；
  - `GET /api/statistics/overview|trend|pages|geography|browsers|hourly|recent`；
  - `GET /api/statistics/visitor/:ip`：按 IP 查询明细；
  - `DELETE /api/statistics/cleanup?days=365`：清理旧数据。
- 认证与权限：
  - 管理后台页面使用 Session 保护（`requireAuth`）；
  - 提供 JWT 工具（`middleware/auth.js`，`authenticateToken`/`requireAdmin`）便于将来扩展 API 级权限；
  - 登录接口：`POST /admin/login`（示例用户名 `admin`，密码见“安全与合规”）。
- 健康与运维：
  - `/health` 健康检查；
  - 进程信号与未捕获异常处理，支持优雅关闭（server.close + 超时兜底）。


## 数据模型（SQLite 摘要）

- 表：`news`
  - 字段：`id`, `title`, `content`, `summary`, `publish_date`, `create_time`, `update_time`, `status`, `author`, `views`, `featured`
- 表：`news_images`
  - 字段：`id`, `news_id`, `image_url`, `image_description`, `image_order`, `original_filename`, `file_size`, `upload_time`
- 表：`visit_statistics`
  - 字段：`id`, `ip_address`, `user_agent`, `page_url`, `referer`, `session_id`, `country`, `city`, `visit_time`

初始化脚本：`backend/scripts/initDatabase.js`（清空并导入示例新闻、示例访问记录）。


## 兼容与回退策略

- 端口约定：
  - 后端推荐在 5500 端口运行（`server.js` 默认）；
  - 前端脚本通过 `window.location.port` 动态判断：
    - `js/news-api.js` 与 `News/*.js`：检测端口 5500 时启用 API；否则回退至静态 JS 数据；
    - `js/visitor-tracker.js`：示例配置为端口 5502 时启用访问上报（可按需调整为 5500）。
- 数据回退：
  - 列表/详情/首页新闻均内置“API 优先，静态回退”逻辑；
  - 图片加载失败自动重试与占位。


## 部署与运行（Windows PowerShell）

注意：后端存在“完整版/简化版”两种依赖方案。若遇到原生依赖安装困难（如 sharp/sqlite3 编译失败），建议先使用简化版。

- 完整版（推荐环境具备 Node 16+）：

```powershell
# 进入后端目录
cd backend

# 使用国内镜像加速（可选）
npm config set registry https://registry.npmmirror.com

# 安装依赖
npm install

# 初始化数据库（写入示例数据）
npm run init-db

# 启动服务（默认 http://localhost:5500）
npm start
```

- 简化版（INSTALL.md 提供的方案）：

```powershell
cd backend
# 一键脚本（会切换 package-simple.json 并安装）
./install-simple.bat

# 按文档将 server.js 的新闻路由改为 news-simple，并将 models 中的 db 引用切为 database-simple
# 初始化数据库
npm run init-db

# 启动服务
npm start
```

- 访问：
  - 前台首页：http://localhost:5500/Main.html
  - 新闻列表：http://localhost:5500/News/News_Page.html
  - 管理后台：http://localhost:5500/admin
  - 健康检查：http://localhost:5500/health

- 生产建议：
  - 前后端同机：Nginx 反向代理到 Node（保留 /uploads 持久化卷，定期备份 `website.db` 与 `uploads/news`）；
  - 配置 HTTPS 与更严格 CSP；
  - 通过环境变量注入 `SESSION_SECRET`、`JWT_SECRET`、`PORT`；
  - 日志与监控（pm2/Windows 服务 + 日志轮转）。


## 安全与合规

- Helmet CSP 已允许必要外源：fonts.googleapis、cdnjs、unpkg、cdn.quilljs；生产可收敛来源并下调 `'unsafe-inline'` 使用；
- CORS 限域于本地开发常用地址，生产请改为站点域名；
- 速率限制：`/api/*` 15 分钟 100 次/IP，防暴力/爬虫基础防护；
- 上传限制：图片 MIME 白名单 + 10MB 限制，完整版含 Jimp 压缩（1200×800，85%）；
- 管理后台默认账号：用户名 `admin`，密码在 `server.js` 里校验为 `admin123`（`login.html` 页面默认值显示为 `123456`，请以 `admin123` 为准并在生产更改）。


## 性能与 SEO

- 性能：滚动与动画合规、API 具备超时/重试、首页组件按需初始化；
- SEO：语义化结构、图片 `alt` 与标题完善（可进一步加入 sitemap.xml/robots.txt、结构化数据、Open Graph）。


## 测试与验证（快速自检）

1. 启动后端，打开首页，首页“组内新闻”应显示数据库数据；若未启动后端，则看到静态示例新闻且“MORE”可跳转；
2. 进入新闻列表页与详情页，验证分页/详情渲染、图片与图注显示；
3. 管理后台登录，新增一条新闻（带图片占位符或直接上传），保存后在前台可见；
4. 刷新后台仪表盘，检查访问与新闻计数；
5. 打开移动端模拟，验证顶部导航与侧边菜单交互、研究领域轮播切换与键盘/触摸操作。


## 未来优化建议

- 权限与审计：基于 JWT 的多角色 RBAC，操作日志留痕；
- 图片服务：引入对象存储与 CDN，服务端生成缩略图与 WebP，自适应裁剪；
- 富文本增强：粘贴图片直传、所见即所得的占位符管理、模板片段；
- 多语言：除首页外的多页面 i18n 文案拆分与路由；
- 搜索与分页：服务端分页与高亮，Elastic/SQLite FTS 拓展；
- 统计可视化：后台用 ECharts 展示趋势、地理与来源分析；
- 构建链路：引入打包与资源指纹，按需加载、HTTP/2 多路复用与缓存策略。


## 附：项目简述（可用于简历 2-3 行版本）

- 负责课题组网站前端架构与实现，基于 Layui + 原生 JS 完成多页面与移动端适配，AOS/IntersectionObserver 优化滚动动画与性能；
- 设计并实现 Node.js + Express + SQLite 的新闻发布与访问统计后端，支持富文本、图片上传/压缩、列表/检索/详情 API；
- 前端具备“API 优先、静态回退”的双数据源策略，离线可用，在线接入后台后自动切换，提升运维与扩展性。